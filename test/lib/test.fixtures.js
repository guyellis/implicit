'use strict';

var _ = require('lodash');
var assert = require('assert');
var checkMemory = require('../../lib/check-memory');
var fs = require('fs');
var getFiles = require('../../lib/get-files');
var path = require('path');

describe('Fixtures', function() {

  it('should test files in fixtures folder', function(done){
    var options = {
      directory: path.join(__dirname, '../fixtures'),
      excludeDir: ['node_modules', 'coverage'],
      includeFiles: ['.js']
    };

    getFiles(options, function(err, files){
      assert(!err);
      assert(_.isArray(files));
      assert.equal(1, files.length);

      files.forEach(function(file){
        var rfile = require(file);
        var contents = fs.readFileSync(file, {encoding: 'utf-8'});
        var results = checkMemory(contents);
        // Ignore the error generated by module.exports
        assert.equal(results.length - 1, rfile.length);
        for(var i = 0; i < results.length - 1; i++) {
          assert.equal(results[i].line, rfile[i].line);
          assert.equal(results[i].character, rfile[i].character);
          assert.equal(results[i].message, rfile[i].message);
        }
        done();
      });

    });

  });

});
